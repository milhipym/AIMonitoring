<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>í”„ë¡œë¯¸ì¹´ ë¡œê·¸ ëª¨ë‹ˆí„°ë§</title>
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="css/contents.css" />
<link rel="stylesheet" href="css/modal.css" />
<link rel="stylesheet" href="css/card.css" />
</head>
<body>
  <div class="cockpit">
    <!-- í—¤ë” -->
    <div class="cockpit-header">
      <h1>â—ˆ LOG MONITORING SYSTEM â—ˆ</h1>
      <p class="subtitle">REAL-TIME ANALYSIS DASHBOARD</p>
    </div>

    <!-- ë©”ì¸ ëª¨ë‹ˆí„° (ëŒ€í˜• ì°¨íŠ¸ í™”ë©´) -->
    <div class="main-monitor">
      <div class="monitor-header">
        <span class="monitor-title">â—† TEMPORAL LOG DISTRIBUTION</span>
        <div class="monitor-indicators">
          <span class="indicator active"></span>
          <span class="indicator"></span>
          <span class="indicator"></span>
        </div>
      </div>
      <div class="monitor-body">
        <div id="chart"></div>
        <progress id="prog" max="100" value="0"></progress>
        <div id="status">
          <span class="status-text">SYSTEM READY - AWAITING LOG FILE</span>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ì½˜ì†” íŒ¨ë„ ê·¸ë¦¬ë“œ -->
    <div class="console-grid">
      <!-- íŒŒì¼ ë¡œë“œ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ FILE LOADER</div>
        <div class="panel-body">
          <div class="upload-zone" id="uploadZone">
            <input id="file" type="file" accept=".log,.txt" />
            <label for="file" class="upload-btn">SELECT FILE</label>
            <span id="file-name">NO FILE LOADED</span>
          </div>
          <div class="file-history">
            <div class="history-header">
              RECENT FILES
              <button class="history-popup-btn" onclick="openHistoryPopup()" title="ì „ì²´ íˆìŠ¤í† ë¦¬ ë³´ê¸°">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="9"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
            <div id="historyList" class="history-list">
              <div class="history-empty">NO HISTORY</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ì œì–´ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ SEARCH CONTROL</div>
        <div class="panel-body">
          <div class="control-group">
            <label>ì¶”ì²œ í‚¤ì›Œë“œ</label>
            <div class="keyword-chips">
              <button class="chip chip-info" onclick="setSearchWord('INFO')">INFO</button>
              <button class="chip chip-error" onclick="setSearchWord('Exception')">Exception</button>
              <button class="chip chip-fatal" onclick="setSearchWord('FATAL')">FATAL</button>
            </div>
          </div>
          <div class="control-group">
            <label>PATTERN</label>
            <input type="text" id="searchWord" placeholder="INFO, Exception, WARN..." value="INFO">
          </div>
          <button class="btn primary" id="btnSearch" onclick="doSearch()">EXECUTE SEARCH</button>
        </div>
      </div>

      <!-- ë¶„ì„ ì˜µì…˜ íŒ¨ë„ -->
      <div class="console-panel">
        <div class="panel-header">â–£ ANALYSIS OPTIONS</div>
        <div class="panel-body">
          <button class="btn btn-cyber-neon" id="btnDetail" onclick="openDetailPopup()">ì¢…í•© ë¶„ì„</button>
          <button class="btn btn-cyber-neon" id="btnErrorAnal" onclick="openDetailPopup()">ì˜¤ë¥˜ ë¶„ì„</button>
          <button class="btn btn-cyber-neon" id="btnSplit" onclick="doSplit()">FILE SPLIT</button>
        </div>
      </div>

      <!-- ë¡œê·¸ ë·°ì–´ íŒ¨ë„ -->
      <div class="console-panel log-viewer-half">
        <div class="panel-header">â–£ LOG VIEWER</div>
        <div class="panel-body">
          <div id="preview"></div>
        </div>
      </div>


    </div>
  </div>

  <!-- ì¢…í•©ë¶„ì„ íŒì—… -->
  <div id="detailPopup" class="detail-popup">
    <div class="detail-popup-content">
      <div class="detail-popup-header">
        <h2>â—† LOG STATISTICS ANALYSIS â—†</h2>
        <button class="detail-close-btn" onclick="closeDetailPopup()">âœ• CLOSE</button>
      </div>
      
      <!-- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
      <div id="analysisLoading" class="analysis-loading">
        <!-- ìë¹„ìŠ¤ ìŠ¤íƒ€ì¼ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ë°°ê²½ -->
        <div class="jarvis-data-streams">
          <div class="data-stream stream-1"></div>
          <div class="data-stream stream-2"></div>
          <div class="data-stream stream-3"></div>
          <div class="data-stream stream-4"></div>
        </div>
        
        <!-- ì›€ì§ì´ëŠ” ë¼ì¸ë“¤ -->
        <div class="jarvis-lines">
          <div class="scan-line line-1"></div>
          <div class="scan-line line-2"></div>
          <div class="scan-line line-3"></div>
        </div>
        
        <!-- ì¶”ê°€ íšŒì „ ë§ë“¤ -->
        <div class="jarvis-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        
        <div class="loading-spinner"></div>
        <div class="loading-text">ANALYZING LOG DATA...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
      </div>
      
      <div id="detailContent" style="display:none;">
        <div class="detail-section">
          <h3>ğŸ“Š Overall Statistics</h3>
          <div class="detail-stats-grid">
            <div class="stat-card">
              <h4>Total Requests</h4>
              <div class="stat-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
              <h4>Exception Count</h4>
              <div class="stat-value" id="errorCount" style="color: #ff6666;">0</div>
            </div>
            <div class="stat-card">
              <h4>Analysis Duration</h4>
              <div class="stat-value" id="analysisDuration" style="font-size: 18px;">-</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>ğŸ† TOP 5 UX_ Requests</h3>
          <div id="topRequests"></div>
        </div>

        <div class="detail-section">
          <h3>âš ï¸ Exceptions</h3>
          <div id="errorLogs" class="error-list"></div>
          <div id="errorPagination" class="error-pagination" style="display:none;">
            <button class="btn-page" onclick="prevErrorPage()">â—€ PREV</button>
            <span class="page-info" id="errorPageInfo">1 / 1</span>
            <button class="btn-page" onclick="nextErrorPage()">NEXT â–¶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="js/logWorkerSource.js"></script>
  <script src="js/plotly-3.1.0.min.js"></script>
  <script src="js/modal.js"></script>
  <script src="js/main.js"></script>
  
  <script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInputEl = document.getElementById('file');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const f = files[0];
        window.logfile = f;
        document.getElementById('file-name').textContent = f.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    fileInputEl.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) {
        document.getElementById('file-name').textContent = f.name;
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    // ì¶”ì²œ í‚¤ì›Œë“œ í´ë¦­ ì‹œ ê²€ìƒ‰ì–´ ìë™ ì…ë ¥
    function setSearchWord(keyword) {
      document.getElementById('searchWord').value = keyword;
      document.getElementById('searchWord').focus();
    }

    // IndexedDB ì„¤ì •
    const DB_NAME = 'LogAnalyzerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'logfiles';
    const FILE_HISTORY_KEY = 'logfile_history';
    const MAX_HISTORY = 15;
    let db = null;

    // IndexedDB ì´ˆê¸°í™”
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    // IndexedDBì— íŒŒì¼ ì €ì¥
    async function saveFileToIndexedDB(file) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const id = `${file.name}_${file.size}`;
        
        const request = store.put({ id, file, timestamp: Date.now() });
        request.onsuccess = () => resolve(id);
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        
        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result.file);
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBì—ì„œ íŒŒì¼ ì‚­ì œ
    async function deleteFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadHistory() {
      try {
        const history = localStorage.getItem(FILE_HISTORY_KEY);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }

    // íˆìŠ¤í† ë¦¬ ì €ì¥
    function saveHistory(history) {
      try {
        localStorage.setItem(FILE_HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    // íˆìŠ¤í† ë¦¬ì— íŒŒì¼ ì¶”ê°€
    async function addToHistory(file) {
      let history = loadHistory();
      
      // ì¤‘ë³µ ì œê±° (ê°™ì€ íŒŒì¼ëª…ê³¼ í¬ê¸°)
      history = history.filter(item => 
        !(item.name === file.name && item.size === file.size)
      );
      
      // ìƒˆ íŒŒì¼ì„ ë§¨ ì•ì— ì¶”ê°€
      history.unshift({
        name: file.name,
        size: file.size,
        timestamp: Date.now()
      });
      
      // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
      history = history.slice(0, MAX_HISTORY);
      
      saveHistory(history);
      
      // IndexedDBì— íŒŒì¼ ì €ì¥
      try {
        await saveFileToIndexedDB(file);
      } catch (e) {
        console.error('Failed to save file to IndexedDB:', e);
      }
      
      updateHistoryUI();
    }

    // íˆìŠ¤í† ë¦¬ì—ì„œ ì‚­ì œ
    function removeFromHistory(index) {
      let history = loadHistory();
      history.splice(index, 1);
      saveHistory(history);
      updateHistoryUI();
    }

    // íŒŒì¼ í¬ê¸° í¬ë§·
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
    }

    // íˆìŠ¤í† ë¦¬ íŒŒì¼ í´ë¦­ ì‹œ ë¡œë“œ
    async function loadFromHistory(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // íŒŒì¼ ìë™ ë¡œë“œ
        window.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ê²€ìƒ‰ ë²„íŠ¼ ê¹œë¹¡ì„ ì¶”ê°€
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
      } else {
        // íŒŒì¼ì´ IndexedDBì— ì—†ìŒ
        alert(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"${item.name}" íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        await deleteFileFromIndexedDB(fileId);
        removeFromHistory(index);
      }
    }

    // íˆìŠ¤í† ë¦¬ UI ì—…ë°ì´íŠ¸ (ìµœì‹  1ê°œë§Œ í‘œì‹œ)
    function updateHistoryUI() {
      const history = loadHistory();
      const historyList = document.getElementById('historyList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">NO HISTORY</div>';
        return;
      }
      
      // ìµœì‹  1ê°œë§Œ í‘œì‹œ
      const latestItem = history[0];
      historyList.innerHTML = `
        <div class="history-item">
          <span class="history-item-name" title="${latestItem.name}" onclick="loadFromHistory(0)">${latestItem.name}</span>
          <span class="history-item-size">${formatFileSize(latestItem.size)}</span>
          <button class="history-item-delete" onclick="removeFromHistory(0)">Ã—</button>
        </div>
      `;
    }

    // ì „ì—­ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤
    let historyModal = null;

    // íˆìŠ¤í† ë¦¬ íŒì—… ì—´ê¸°
    function openHistoryPopup() {
      const history = loadHistory();
      
      if (history.length === 0) {
        alert('ì €ì¥ëœ íŒŒì¼ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const popupContent = `
        <div class="history-popup-header">
          <h3>íŒŒì¼ íˆìŠ¤í† ë¦¬ (${history.length}ê°œ)</h3>
          <button class="popup-close-btn" onclick="closeHistoryPopup()">Ã—</button>
        </div>
        <div class="history-popup-list">
          ${history.map((item, index) => `
            <div class="history-popup-item">
              <div class="popup-item-info" onclick="loadFromHistoryPopup(${index})">
                <span class="popup-item-name" title="${item.name}">${item.name}</span>
                <span class="popup-item-size">${formatFileSize(item.size)}</span>
              </div>
              <button class="popup-item-delete" onclick="removeFromHistoryPopup(${index})">ì‚­ì œ</button>
            </div>
          `).join('')}
        </div>
      `;
      
      // Modal ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      historyModal = new Modal({
        size: 'md',
        title: '',
        closeOnEsc: true,
        closeOnOverlay: true
      });
      
      historyModal.setContent(popupContent);
      historyModal.open();
    }

    // íŒì—… ë‹«ê¸°
    function closeHistoryPopup() {
      if (historyModal) {
        historyModal.close();
        historyModal = null;
      }
    }

    // íŒì—…ì—ì„œ íŒŒì¼ ë¡œë“œ
    async function loadFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // íŒŒì¼ ìë™ ë¡œë“œ
        window.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ê²€ìƒ‰ ë²„íŠ¼ ê¹œë¹¡ì„ ì¶”ê°€
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
        
        // íŒì—… ë‹«ê¸°
        closeHistoryPopup();
      } else {
        // íŒŒì¼ì´ IndexedDBì— ì—†ìŒ
        alert(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"${item.name}" íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        await removeFromHistoryPopup(index);
      }
    }

    // íŒì—…ì—ì„œ íŒŒì¼ ì‚­ì œ
    async function removeFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (item) {
        const fileId = `${item.name}_${item.size}`;
        await deleteFileFromIndexedDB(fileId);
      }
      
      removeFromHistory(index);
      
      // íŒì—… ë‚´ìš© ê°±ì‹ 
      const newHistory = loadHistory();
      if (newHistory.length === 0) {
        closeHistoryPopup();
        return;
      }
      
      // íŒì—… ë‹¤ì‹œ ì—´ê¸° (ê°±ì‹ )
      closeHistoryPopup();
      setTimeout(() => openHistoryPopup(), 100);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ IndexedDB ì´ˆê¸°í™”
    (async function() {
      await initDB();
      updateHistoryUI();
    })();

    // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ë¡œë“œ
    updateHistoryUI();

    // ë¡œê·¸ ë¶„ì„ ë°ì´í„° ì €ì¥
    let logAnalysisData = {
      totalRequests: 0,
      uxRequests: {},
      errors: [],
      totalErrorCount: 0,
      timeStart: null,
      timeEnd: null
    };

    // ì—ëŸ¬ í˜ì´ì§€ë„¤ì´ì…˜
    let currentErrorPage = 1;
    const ERRORS_PER_PAGE = 20;

    // ì¢…í•©ë¶„ì„ íŒì—… ì—´ê¸°
    async function openDetailPopup() {
      if (!window.logfile) {
        alert("ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œ í›„ 'EXECUTE SEARCH' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš” !!");
        return;
      }
      
      // ê²€ìƒ‰ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
      if (!window.searchObj || !window.searchObj.searchLineStartByteArray) {
        alert("ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œ í›„ 'EXECUTE SEARCH' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš” !!");
        return;
      }

      const popup = document.getElementById('detailPopup');
      popup.classList.add('active');
      
      // ë¡œë”© í‘œì‹œ, ê²°ê³¼ ìˆ¨ê¹€
      document.getElementById('analysisLoading').style.display = 'flex';
      document.getElementById('detailContent').style.display = 'none';
      document.getElementById('loadingProgress').textContent = '0%';
      
      // ë¡œê·¸ ë¶„ì„ ì‹œì‘
      await analyzeLogFile();
      
      // ë¡œë”© ìˆ¨ê¹€, ê²°ê³¼ í‘œì‹œ
      document.getElementById('analysisLoading').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      // ê²°ê³¼ í‘œì‹œ
      currentErrorPage = 1;
      displayAnalysisResults();
    }

    // ì¢…í•©ë¶„ì„ íŒì—… ë‹«ê¸°
    function closeDetailPopup() {
      const popup = document.getElementById('detailPopup');
      popup.classList.remove('active');
    }

    // ë¡œê·¸ íŒŒì¼ ë¶„ì„ (ì²­í¬ ë°©ì‹ - ëŒ€ìš©ëŸ‰ íŒŒì¼ ì§€ì›)
    async function analyzeLogFile() {
      const file = window.logfile;
      if (!file) return;

      // ë¶„ì„ ë°ì´í„° ì´ˆê¸°í™”
      logAnalysisData = {
        totalRequests: 0,
        uxRequests: {},
        errors: [],
        totalErrorCount: 0,
        timeStart: null,
        timeEnd: null
      };

      const CHUNK_SIZE = 10 * 1024 * 1024; // 10MBì”© ì½ê¸°
      let offset = 0;
      let lineNumber = 0;
      let leftover = '';

      // ì§„í–‰ìƒí™© í‘œì‹œ
      const loadingProgress = document.getElementById('loadingProgress');
      
      while (offset < file.size) {
        const chunkEnd = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = file.slice(offset, chunkEnd);
        const text = await chunk.text();
        const combined = leftover + text;
        
        const lines = combined.split('\n');
        
        // ë§ˆì§€ë§‰ ë¼ì¸ì€ ë‹¤ìŒ ì²­í¬ë¡œ ì´ì›” (ë¶ˆì™„ì „í•  ìˆ˜ ìˆìŒ)
        if (chunkEnd < file.size) {
          leftover = lines.pop() || '';
        } else {
          leftover = '';
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          lineNumber++;

          // _BIZREQUEST ì¶”ì¶œ
          if (line.includes('_BIZREQUEST')) {
            logAnalysisData.totalRequests++;
            
            // UX_ ìš”ì²­ ì¶”ì¶œ
            const uxMatch = line.match(/_BIZREQUEST[:\s]+([A-Z_0-9]+)/);
            if (uxMatch && uxMatch[1].startsWith('UX_')) {
              const reqName = uxMatch[1];
              logAnalysisData.uxRequests[reqName] = (logAnalysisData.uxRequests[reqName] || 0) + 1;
            }
          }

          // Exception ì¶”ì¶œ (Exception, Error:) - ë©€í‹°ë¼ì¸ ì§€ì›
          if (line.includes('Exception') || line.includes('Error:')) {
            logAnalysisData.totalErrorCount++;
            
            // ìƒì„¸ ë‚´ìš©ì€ ìµœëŒ€ 1000ê°œë§Œ ì €ì¥ (í˜ì´ì§€ë„¤ì´ì…˜ìš©)
            if (logAnalysisData.errors.length < 1000) {
              // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ
              const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
              const timestamp = timeMatch ? timeMatch[1] : '';
              
              // Exception íƒ€ì…
              let errorType = 'Exception';
              
              // Exception ë³¸ë¬¸ + ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ìˆ˜ì§‘
              let fullErrorContent = line.trim();
              let additionalLines = 0;
              for (let j = i + 1; j < Math.min(i + 50, lines.length); j++) {
                const nextLine = lines[j].trim();
                // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë¼ì¸ì¸ì§€ í™•ì¸
                if (nextLine.startsWith('at ') || 
                    nextLine.startsWith('Caused by:') || 
                    nextLine.startsWith('Suppressed:') || 
                    nextLine.startsWith('...')) {
                  fullErrorContent += '\n' + nextLine;
                  additionalLines++;
                } else if (!nextLine || 
                          /^\d{2}:\d{2}:\d{2}/.test(nextLine) || 
                          /^(?:[A-Z]+\s+)?\[?\d{4}[-\/]\d{2}[-\/]\d{2}[\sT]\d{2}:\d{2}:\d{2}/.test(nextLine)) {
                  break;
                } else {
                  break;
                }
              }
              
              logAnalysisData.errors.push({
                line: lineNumber,
                timestamp: timestamp,
                errorType: errorType,
                content: fullErrorContent,
                lines: additionalLines + 1
              });
              
              i += additionalLines;
              lineNumber += additionalLines;
            }
          }

          // ì‹œê°„ ë²”ìœ„ ì¶”ì¶œ
          const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
          if (timeMatch) {
            if (!logAnalysisData.timeStart) {
              logAnalysisData.timeStart = timeMatch[1];
            }
            logAnalysisData.timeEnd = timeMatch[1];
          }
        }

        offset = chunkEnd;
        
        const percent = Math.min(Math.floor((offset / file.size) * 100), 100);
        if (loadingProgress) {
          loadingProgress.textContent = `${percent}%`;
        }
      }
    }

    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayAnalysisResults() {
      document.getElementById('totalRequests').textContent = logAnalysisData.totalRequests.toLocaleString();
      document.getElementById('errorCount').textContent = logAnalysisData.totalErrorCount.toLocaleString();
      
      if (logAnalysisData.timeStart && logAnalysisData.timeEnd) {
        document.getElementById('analysisDuration').textContent = 
          `${logAnalysisData.timeStart} ~ ${logAnalysisData.timeEnd}`;
      }

      // TOP 5 UX_ ìš”ì²­
      const topRequests = Object.entries(logAnalysisData.uxRequests)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const topRequestsHTML = topRequests.map((item, index) => `
        <div class="stat-card">
          <h4>${index + 1}. ${item[0]}</h4>
          <div class="stat-value" style="font-size: 20px;">${item[1].toLocaleString()} íšŒ</div>
        </div>
      `).join('');
      
      document.getElementById('topRequests').innerHTML = `
        <div class="detail-stats-grid">${topRequestsHTML || '<p style="color: #888;">UX_ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div>
      `;

      displayErrorPage();
    }

    // ì—ëŸ¬ í˜ì´ì§€ í‘œì‹œ
    function displayErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      const startIdx = (currentErrorPage - 1) * ERRORS_PER_PAGE;
      const endIdx = Math.min(startIdx + ERRORS_PER_PAGE, logAnalysisData.errors.length);
      
      const errorHTML = logAnalysisData.errors.slice(startIdx, endIdx).map(err => {
        const errorColor = '#ff9900';
        return `
          <div class="error-item">
            <div class="error-header">
              <span class="error-type" style="color: ${errorColor};">â—† ${err.errorType}</span>
              <span class="error-line">Line ${err.line}</span>
              ${err.timestamp ? `<span class="error-time">â± ${err.timestamp}</span>` : ''}
            </div>
            <div class="error-content">${err.content}</div>
          </div>
        `;
      }).join('');
      
      const errorWarning = logAnalysisData.totalErrorCount > logAnalysisData.errors.length
        ? `<p style="color: #ff6b9d; margin-top: 10px;">âš ï¸ ì´ ${logAnalysisData.totalErrorCount.toLocaleString()}ê°œ Exception ì¤‘ ${logAnalysisData.errors.length.toLocaleString()}ê°œê¹Œì§€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` 
        : '';
      
      document.getElementById('errorLogs').innerHTML = (errorHTML || 
        '<p style="color: #888;">Exceptionì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>') + errorWarning;
      
      const pagination = document.getElementById('errorPagination');
      if (logAnalysisData.errors.length > ERRORS_PER_PAGE) {
        pagination.style.display = 'flex';
        document.getElementById('errorPageInfo').textContent = `${currentErrorPage} / ${totalPages}`;
        
        const prevBtn = pagination.querySelector('button:first-child');
        const nextBtn = pagination.querySelector('button:last-child');
        
        prevBtn.disabled = currentErrorPage === 1;
        nextBtn.disabled = currentErrorPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // ì´ì „ í˜ì´ì§€
    function prevErrorPage() {
      if (currentErrorPage > 1) {
        currentErrorPage--;
        displayErrorPage();
      }
    }

    // ë‹¤ìŒ í˜ì´ì§€
    function nextErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      if (currentErrorPage < totalPages) {
        currentErrorPage++;
        displayErrorPage();
      }
    }

    // ë¡œê·¸ ë¶„ì„ ì™„ë£Œ ì‹œ ì¢…í•©ë¶„ì„ ë²„íŠ¼ í‘œì‹œ
    window.addEventListener('message', function(e) {
      if (e.data && e.data.cmd === 'complete') {
        const detailBtn = document.getElementById('btnDetail');
        if (detailBtn) {
          detailBtn.style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>
