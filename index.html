<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ÌîÑÎ°úÎØ∏Ïπ¥ Î°úÍ∑∏ Î™®ÎãàÌÑ∞ÎßÅ</title>
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="css/contents.css" />
<link rel="stylesheet" href="css/modal.css" />
<link rel="stylesheet" href="css/card.css" />
</head>
<body>
  <div class="cockpit">
    <!-- Ìó§Îçî -->
    <div class="cockpit-header">
      <h1>‚óà LOG MONITORING SYSTEM ‚óà</h1>
      <p class="subtitle">REAL-TIME ANALYSIS DASHBOARD</p>
    </div>

    <!-- Î©îÏù∏ Î™®ÎãàÌÑ∞ (ÎåÄÌòï Ï∞®Ìä∏ ÌôîÎ©¥) -->
    <div class="main-monitor">
      <div class="monitor-header">
        <span class="monitor-title">‚óÜ TEMPORAL LOG DISTRIBUTION</span>
        <div class="monitor-indicators">
          <span class="indicator active"></span>
          <span class="indicator"></span>
          <span class="indicator"></span>
        </div>
      </div>
      <div class="monitor-body">
        <div id="chart"></div>
        <progress id="prog" max="100" value="0"></progress>
        <div id="status">
          <span class="status-text">SYSTEM READY - AWAITING LOG FILE</span>
        </div>
      </div>
    </div>

    <!-- ÌïòÎã® ÏΩòÏÜî Ìå®ÎÑê Í∑∏Î¶¨Îìú -->
    <div class="console-grid">
      <!-- ÌååÏùº Î°úÎìú Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ FILE LOADER</div>
        <div class="panel-body">
          <div class="upload-zone" id="uploadZone">
            <input id="file" type="file" accept=".log,.txt" />
            <label for="file" class="upload-btn">SELECT FILE</label>
            <span id="file-name">NO FILE LOADED</span>
          </div>
          <div class="file-history">
            <div class="history-header">
              RECENT FILES
              <button class="history-popup-btn" onclick="openHistoryPopup()" title="Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ Î≥¥Í∏∞">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="9"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
              </button>
            </div>
            <div id="historyList" class="history-list">
              <div class="history-empty">NO HISTORY</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Í≤ÄÏÉâ Ï†úÏñ¥ Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ SEARCH CONTROL</div>
        <div class="panel-body">
          <div class="control-group">
            <label>Ï∂îÏ≤ú ÌÇ§ÏõåÎìú</label>
            <div class="keyword-chips">
              <button class="chip chip-info" onclick="setSearchWord('INFO')">INFO</button>
              <button class="chip chip-error" onclick="setSearchWord('Exception')">Exception</button>
              <button class="chip chip-fatal" onclick="setSearchWord('FATAL')">FATAL</button>
            </div>
          </div>
          <div class="control-group">
            <label>PATTERN</label>
            <input type="text" id="searchWord" placeholder="INFO, Exception, WARN..." value="INFO">
          </div>
          <button class="btn primary" id="btnSearch" onclick="doSearch()">EXECUTE SEARCH</button>
        </div>
      </div>

      <!-- Î∂ÑÏÑù ÏòµÏÖò Ìå®ÎÑê -->
      <div class="console-panel">
        <div class="panel-header">‚ñ£ ANALYSIS OPTIONS</div>
        <div class="panel-body">
          <button class="btn btn-cyber-neon" id="btnDetail" onclick="openDetailPopup()">Ï¢ÖÌï© Î∂ÑÏÑù</button>
          <button class="btn btn-cyber-neon" id="btnErrorAnal" onclick="openDetailPopup()">Ïò§Î•ò Î∂ÑÏÑù</button>
          <button class="btn btn-cyber-neon" id="btnSplit" onclick="doSplit()">FILE SPLIT</button>
        </div>
      </div>

      <!-- Î°úÍ∑∏ Î∑∞Ïñ¥ Ìå®ÎÑê -->
      <div class="console-panel log-viewer-half">
        <div class="panel-header">‚ñ£ LOG VIEWER</div>
        <div class="panel-body">
          <div id="preview"></div>
        </div>
      </div>


    </div>
  </div>

  <!-- Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ -->
  <div id="detailPopup" class="detail-popup">
    <div class="detail-popup-content">
      <div class="detail-popup-header">
        <h2>‚óÜ LOG STATISTICS ANALYSIS ‚óÜ</h2>
        <button class="detail-close-btn" onclick="closeDetailPopup()">‚úï CLOSE</button>
      </div>
      
      <!-- Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò -->
      <div id="analysisLoading" class="analysis-loading">
        <!-- ÏûêÎπÑÏä§ Ïä§ÌÉÄÏùº Îç∞Ïù¥ÌÑ∞ Ïä§Ìä∏Î¶º Î∞∞Í≤Ω -->
        <div class="jarvis-data-streams">
          <div class="data-stream stream-1"></div>
          <div class="data-stream stream-2"></div>
          <div class="data-stream stream-3"></div>
          <div class="data-stream stream-4"></div>
        </div>
        
        <!-- ÏõÄÏßÅÏù¥Îäî ÎùºÏù∏Îì§ -->
        <div class="jarvis-lines">
          <div class="scan-line line-1"></div>
          <div class="scan-line line-2"></div>
          <div class="scan-line line-3"></div>
        </div>
        
        <!-- Ï∂îÍ∞Ä ÌöåÏ†Ñ ÎßÅÎì§ -->
        <div class="jarvis-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        
        <div class="loading-spinner"></div>
        <div class="loading-text">ANALYZING LOG DATA...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
      </div>
      
      <div id="detailContent" style="display:none;">
        <div class="detail-section">
          <h3>üìä Overall Statistics</h3>
          <div class="detail-stats-grid">
            <div class="stat-card">
              <h4>Total Requests</h4>
              <div class="stat-value" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
              <h4>Exception Count</h4>
              <div class="stat-value" id="errorCount" style="color: #ff6666;">0</div>
            </div>
            <div class="stat-card">
              <h4>Analysis Duration</h4>
              <div class="stat-value" id="analysisDuration" style="font-size: 18px;">-</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>üèÜ TOP 5 UX_ Requests</h3>
          <div id="topRequests"></div>
        </div>

        <div class="detail-section">
          <h3>‚ö†Ô∏è Exceptions</h3>
          <div id="errorLogs" class="error-list"></div>
          <div id="errorPagination" class="error-pagination" style="display:none;">
            <button class="btn-page" onclick="prevErrorPage()">‚óÄ PREV</button>
            <span class="page-info" id="errorPageInfo">1 / 1</span>
            <button class="btn-page" onclick="nextErrorPage()">NEXT ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="js/logWorkerSource.js"></script>
  <script src="js/plotly-3.1.0.min.js"></script>
  <script src="js/modal.js"></script>
  <script src="js/main.js"></script>
  
  <script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInputEl = document.getElementById('file');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const f = files[0];
        window.logfile = f;
        document.getElementById('file-name').textContent = f.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    fileInputEl.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) {
        document.getElementById('file-name').textContent = f.name;
        
        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
        if (typeof addToHistory === 'function') {
          addToHistory(f);
        }
      }
    });

    // Ï∂îÏ≤ú ÌÇ§ÏõåÎìú ÌÅ¥Î¶≠ Ïãú Í≤ÄÏÉâÏñ¥ ÏûêÎèô ÏûÖÎ†•
    function setSearchWord(keyword) {
      document.getElementById('searchWord').value = keyword;
      document.getElementById('searchWord').focus();
    }

    // IndexedDB ÏÑ§Ï†ï
    const DB_NAME = 'LogAnalyzerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'logfiles';
    const FILE_HISTORY_KEY = 'logfile_history';
    const MAX_HISTORY = 15;
    let db = null;

    // IndexedDB Ï¥àÍ∏∞Ìôî
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    // IndexedDBÏóê ÌååÏùº Ï†ÄÏû•
    async function saveFileToIndexedDB(file) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const id = `${file.name}_${file.size}`;
        
        const request = store.put({ id, file, timestamp: Date.now() });
        request.onsuccess = () => resolve(id);
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
    async function loadFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        
        request.onsuccess = () => {
          if (request.result) {
            resolve(request.result.file);
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    // IndexedDBÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú
    async function deleteFileFromIndexedDB(id) {
      if (!db) await initDB();
      
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ÌûàÏä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
    function loadHistory() {
      try {
        const history = localStorage.getItem(FILE_HISTORY_KEY);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        return [];
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
    function saveHistory(history) {
      try {
        localStorage.setItem(FILE_HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÌååÏùº Ï∂îÍ∞Ä
    async function addToHistory(file) {
      let history = loadHistory();
      
      // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ ÌååÏùºÎ™ÖÍ≥º ÌÅ¨Í∏∞)
      history = history.filter(item => 
        !(item.name === file.name && item.size === file.size)
      );
      
      // ÏÉà ÌååÏùºÏùÑ Îß® ÏïûÏóê Ï∂îÍ∞Ä
      history.unshift({
        name: file.name,
        size: file.size,
        timestamp: Date.now()
      });
      
      // ÏµúÎåÄ Í∞úÏàò Ï†úÌïú
      history = history.slice(0, MAX_HISTORY);
      
      saveHistory(history);
      
      // IndexedDBÏóê ÌååÏùº Ï†ÄÏû•
      try {
        await saveFileToIndexedDB(file);
      } catch (e) {
        console.error('Failed to save file to IndexedDB:', e);
      }
      
      updateHistoryUI();
    }

    // ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú ÏÇ≠Ï†ú
    function removeFromHistory(index) {
      let history = loadHistory();
      history.splice(index, 1);
      saveHistory(history);
      updateHistoryUI();
    }

    // ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
    }

    // ÌûàÏä§ÌÜ†Î¶¨ ÌååÏùº ÌÅ¥Î¶≠ Ïãú Î°úÎìú
    async function loadFromHistory(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // ÌååÏùº ÏûêÎèô Î°úÎìú
        window.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // Í≤ÄÏÉâ Î≤ÑÌäº ÍπúÎπ°ÏûÑ Ï∂îÍ∞Ä
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
      } else {
        // ÌååÏùºÏù¥ IndexedDBÏóê ÏóÜÏùå
        alert(`ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n"${item.name}" ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`);
        await deleteFileFromIndexedDB(fileId);
        removeFromHistory(index);
      }
    }

    // ÌûàÏä§ÌÜ†Î¶¨ UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏµúÏã† 1Í∞úÎßå ÌëúÏãú)
    function updateHistoryUI() {
      const history = loadHistory();
      const historyList = document.getElementById('historyList');
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">NO HISTORY</div>';
        return;
      }
      
      // ÏµúÏã† 1Í∞úÎßå ÌëúÏãú
      const latestItem = history[0];
      historyList.innerHTML = `
        <div class="history-item">
          <span class="history-item-name" title="${latestItem.name}" onclick="loadFromHistory(0)">${latestItem.name}</span>
          <span class="history-item-size">${formatFileSize(latestItem.size)}</span>
          <button class="history-item-delete" onclick="removeFromHistory(0)">√ó</button>
        </div>
      `;
    }

    // Ï†ÑÏó≠ Î™®Îã¨ Ïù∏Ïä§ÌÑ¥Ïä§
    let historyModal = null;

    // ÌûàÏä§ÌÜ†Î¶¨ ÌåùÏóÖ Ïó¥Í∏∞
    function openHistoryPopup() {
      const history = loadHistory();
      
      if (history.length === 0) {
        alert('Ï†ÄÏû•Îêú ÌååÏùº ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }
      
      const popupContent = `
        <div class="history-popup-header">
          <h3>ÌååÏùº ÌûàÏä§ÌÜ†Î¶¨ (${history.length}Í∞ú)</h3>
          <button class="popup-close-btn" onclick="closeHistoryPopup()">√ó</button>
        </div>
        <div class="history-popup-list">
          ${history.map((item, index) => `
            <div class="history-popup-item">
              <div class="popup-item-info" onclick="loadFromHistoryPopup(${index})">
                <span class="popup-item-name" title="${item.name}">${item.name}</span>
                <span class="popup-item-size">${formatFileSize(item.size)}</span>
              </div>
              <button class="popup-item-delete" onclick="removeFromHistoryPopup(${index})">ÏÇ≠Ï†ú</button>
            </div>
          `).join('')}
        </div>
      `;
      
      // Modal Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
      historyModal = new Modal({
        size: 'md',
        title: '',
        closeOnEsc: true,
        closeOnOverlay: true
      });
      
      historyModal.setContent(popupContent);
      historyModal.open();
    }

    // ÌåùÏóÖ Îã´Í∏∞
    function closeHistoryPopup() {
      if (historyModal) {
        historyModal.close();
        historyModal = null;
      }
    }

    // ÌåùÏóÖÏóêÏÑú ÌååÏùº Î°úÎìú
    async function loadFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (!item) return;
      
      // IndexedDBÏóêÏÑú ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
      const fileId = `${item.name}_${item.size}`;
      const file = await loadFileFromIndexedDB(fileId);
      
      if (file) {
        // ÌååÏùº ÏûêÎèô Î°úÎìú
        window.logfile = file;
        document.getElementById('file-name').textContent = file.name;
        
        if (typeof chartDragClear === 'function') {
          chartDragClear();
        }
        window.timeRangeSize = 24;
        
        // Í≤ÄÏÉâ Î≤ÑÌäº ÍπúÎπ°ÏûÑ Ï∂îÍ∞Ä
        const searchBtn = document.getElementById('btnSearch');
        if (searchBtn) {
          searchBtn.classList.add('btn-blink');
        }
        
        // ÌåùÏóÖ Îã´Í∏∞
        closeHistoryPopup();
      } else {
        // ÌååÏùºÏù¥ IndexedDBÏóê ÏóÜÏùå
        alert(`ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n"${item.name}" ÌååÏùºÏùÑ Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.`);
        await removeFromHistoryPopup(index);
      }
    }

    // ÌåùÏóÖÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú
    async function removeFromHistoryPopup(index) {
      const history = loadHistory();
      const item = history[index];
      
      if (item) {
        const fileId = `${item.name}_${item.size}`;
        await deleteFileFromIndexedDB(fileId);
      }
      
      removeFromHistory(index);
      
      // ÌåùÏóÖ ÎÇ¥Ïö© Í∞±Ïã†
      const newHistory = loadHistory();
      if (newHistory.length === 0) {
        closeHistoryPopup();
        return;
      }
      
      // ÌåùÏóÖ Îã§Ïãú Ïó¥Í∏∞ (Í∞±Ïã†)
      closeHistoryPopup();
      setTimeout(() => openHistoryPopup(), 100);
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú IndexedDB Ï¥àÍ∏∞Ìôî
    (async function() {
      await initDB();
      updateHistoryUI();
    })();

    // Ï¥àÍ∏∞ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
    updateHistoryUI();

    // Î°úÍ∑∏ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    let logAnalysisData = {
      totalRequests: 0,
      uxRequests: {},
      errors: [],
      totalErrorCount: 0,
      timeStart: null,
      timeEnd: null
    };

    // ÏóêÎü¨ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
    let currentErrorPage = 1;
    const ERRORS_PER_PAGE = 20;

    // Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ Ïó¥Í∏∞
    async function openDetailPopup() {
      if (!window.logfile) {
        alert("Î°úÍ∑∏ ÌååÏùºÏùÑ ÏóÖÎ°úÎìú ÌõÑ 'EXECUTE SEARCH' Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî !!");
        return;
      }
      
      // Í≤ÄÏÉâ ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
      if (!window.searchObj || !window.searchObj.searchLineStartByteArray) {
        alert("Î°úÍ∑∏ ÌååÏùºÏùÑ ÏóÖÎ°úÎìú ÌõÑ 'EXECUTE SEARCH' Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî !!");
        return;
      }

      const popup = document.getElementById('detailPopup');
      popup.classList.add('active');
      
      // Î°úÎî© ÌëúÏãú, Í≤∞Í≥º Ïà®ÍπÄ
      document.getElementById('analysisLoading').style.display = 'flex';
      document.getElementById('detailContent').style.display = 'none';
      document.getElementById('loadingProgress').textContent = '0%';
      
      // Î°úÍ∑∏ Î∂ÑÏÑù ÏãúÏûë
      await analyzeLogFile();
      
      // Î°úÎî© Ïà®ÍπÄ, Í≤∞Í≥º ÌëúÏãú
      document.getElementById('analysisLoading').style.display = 'none';
      document.getElementById('detailContent').style.display = 'block';
      
      // Í≤∞Í≥º ÌëúÏãú
      currentErrorPage = 1;
      displayAnalysisResults();
    }

    // Ï¢ÖÌï©Î∂ÑÏÑù ÌåùÏóÖ Îã´Í∏∞
    function closeDetailPopup() {
      const popup = document.getElementById('detailPopup');
      popup.classList.remove('active');
    }

    // Î°úÍ∑∏ ÌååÏùº Î∂ÑÏÑù (Ï≤≠ÌÅ¨ Î∞©Ïãù - ÎåÄÏö©Îüâ ÌååÏùº ÏßÄÏõê)
    async function analyzeLogFile() {
      const file = window.logfile;
      if (!file) return;

      // Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
      logAnalysisData = {
        totalRequests: 0,
        uxRequests: {},
        errors: [],
        totalErrorCount: 0,
        timeStart: null,
        timeEnd: null
      };

      const CHUNK_SIZE = 10 * 1024 * 1024; // 10MBÏî© ÏùΩÍ∏∞
      let offset = 0;
      let lineNumber = 0;
      let leftover = '';

      // ÏßÑÌñâÏÉÅÌô© ÌëúÏãú
      const loadingProgress = document.getElementById('loadingProgress');
      
      while (offset < file.size) {
        const chunkEnd = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = file.slice(offset, chunkEnd);
        const text = await chunk.text();
        const combined = leftover + text;
        
        const lines = combined.split('\n');
        
        // ÎßàÏßÄÎßâ ÎùºÏù∏ÏùÄ Îã§Ïùå Ï≤≠ÌÅ¨Î°ú Ïù¥Ïõî (Î∂àÏôÑÏ†ÑÌï† Ïàò ÏûàÏùå)
        if (chunkEnd < file.size) {
          leftover = lines.pop() || '';
        } else {
          leftover = '';
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          lineNumber++;

          // _BIZREQUEST Ï∂îÏ∂ú
          if (line.includes('_BIZREQUEST')) {
            logAnalysisData.totalRequests++;
            
            // UX_ ÏöîÏ≤≠ Ï∂îÏ∂ú
            const uxMatch = line.match(/_BIZREQUEST[:\s]+([A-Z_0-9]+)/);
            if (uxMatch && uxMatch[1].startsWith('UX_')) {
              const reqName = uxMatch[1];
              logAnalysisData.uxRequests[reqName] = (logAnalysisData.uxRequests[reqName] || 0) + 1;
            }
          }

          // Exception Ï∂îÏ∂ú (Exception, Error:) - Î©ÄÌã∞ÎùºÏù∏ ÏßÄÏõê
          if (line.includes('Exception') || line.includes('Error:')) {
            logAnalysisData.totalErrorCount++;
            
            // ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÄ ÏµúÎåÄ 1000Í∞úÎßå Ï†ÄÏû• (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖòÏö©)
            if (logAnalysisData.errors.length < 1000) {
              // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÏ∂ú
              const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
              const timestamp = timeMatch ? timeMatch[1] : '';
              
              // Exception ÌÉÄÏûÖ
              let errorType = 'Exception';
              
              // Exception Î≥∏Î¨∏ + Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§ ÏàòÏßë
              let fullErrorContent = line.trim();
              let additionalLines = 0;
              for (let j = i + 1; j < Math.min(i + 50, lines.length); j++) {
                const nextLine = lines[j].trim();
                // Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§ ÎùºÏù∏Ïù∏ÏßÄ ÌôïÏù∏
                if (nextLine.startsWith('at ') || 
                    nextLine.startsWith('Caused by:') || 
                    nextLine.startsWith('Suppressed:') || 
                    nextLine.startsWith('...')) {
                  fullErrorContent += '\n' + nextLine;
                  additionalLines++;
                } else if (!nextLine || 
                          /^\d{2}:\d{2}:\d{2}/.test(nextLine) || 
                          /^(?:[A-Z]+\s+)?\[?\d{4}[-\/]\d{2}[-\/]\d{2}[\sT]\d{2}:\d{2}:\d{2}/.test(nextLine)) {
                  break;
                } else {
                  break;
                }
              }
              
              logAnalysisData.errors.push({
                line: lineNumber,
                timestamp: timestamp,
                errorType: errorType,
                content: fullErrorContent,
                lines: additionalLines + 1
              });
              
              i += additionalLines;
              lineNumber += additionalLines;
            }
          }

          // ÏãúÍ∞Ñ Î≤îÏúÑ Ï∂îÏ∂ú
          const timeMatch = line.match(/(\d{2}:\d{2}:\d{2})/);
          if (timeMatch) {
            if (!logAnalysisData.timeStart) {
              logAnalysisData.timeStart = timeMatch[1];
            }
            logAnalysisData.timeEnd = timeMatch[1];
          }
        }

        offset = chunkEnd;
        
        const percent = Math.min(Math.floor((offset / file.size) * 100), 100);
        if (loadingProgress) {
          loadingProgress.textContent = `${percent}%`;
        }
      }
    }

    // Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú
    function displayAnalysisResults() {
      document.getElementById('totalRequests').textContent = logAnalysisData.totalRequests.toLocaleString();
      document.getElementById('errorCount').textContent = logAnalysisData.totalErrorCount.toLocaleString();
      
      if (logAnalysisData.timeStart && logAnalysisData.timeEnd) {
        document.getElementById('analysisDuration').textContent = 
          `${logAnalysisData.timeStart} ~ ${logAnalysisData.timeEnd}`;
      }

      // TOP 5 UX_ ÏöîÏ≤≠
      const topRequests = Object.entries(logAnalysisData.uxRequests)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const topRequestsHTML = topRequests.map((item, index) => `
        <div class="stat-card">
          <h4>${index + 1}. ${item[0]}</h4>
          <div class="stat-value" style="font-size: 20px;">${item[1].toLocaleString()} Ìöå</div>
        </div>
      `).join('');
      
      document.getElementById('topRequests').innerHTML = `
        <div class="detail-stats-grid">${topRequestsHTML || '<p style="color: #888;">UX_ ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>'}</div>
      `;

      displayErrorPage();
    }

    // ÏóêÎü¨ ÌéòÏù¥ÏßÄ ÌëúÏãú
    function displayErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      const startIdx = (currentErrorPage - 1) * ERRORS_PER_PAGE;
      const endIdx = Math.min(startIdx + ERRORS_PER_PAGE, logAnalysisData.errors.length);
      
      const errorHTML = logAnalysisData.errors.slice(startIdx, endIdx).map(err => {
        const errorColor = '#ff9900';
        return `
          <div class="error-item">
            <div class="error-header">
              <span class="error-type" style="color: ${errorColor};">‚óÜ ${err.errorType}</span>
              <span class="error-line">Line ${err.line}</span>
              ${err.timestamp ? `<span class="error-time">‚è± ${err.timestamp}</span>` : ''}
            </div>
            <div class="error-content">${err.content}</div>
          </div>
        `;
      }).join('');
      
      const errorWarning = logAnalysisData.totalErrorCount > logAnalysisData.errors.length
        ? `<p style="color: #ff6b9d; margin-top: 10px;">‚ö†Ô∏è Ï¥ù ${logAnalysisData.totalErrorCount.toLocaleString()}Í∞ú Exception Ï§ë ${logAnalysisData.errors.length.toLocaleString()}Í∞úÍπåÏßÄ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.</p>` 
        : '';
      
      document.getElementById('errorLogs').innerHTML = (errorHTML || 
        '<p style="color: #888;">ExceptionÏù¥ Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>') + errorWarning;
      
      const pagination = document.getElementById('errorPagination');
      if (logAnalysisData.errors.length > ERRORS_PER_PAGE) {
        pagination.style.display = 'flex';
        document.getElementById('errorPageInfo').textContent = `${currentErrorPage} / ${totalPages}`;
        
        const prevBtn = pagination.querySelector('button:first-child');
        const nextBtn = pagination.querySelector('button:last-child');
        
        prevBtn.disabled = currentErrorPage === 1;
        nextBtn.disabled = currentErrorPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ
    function prevErrorPage() {
      if (currentErrorPage > 1) {
        currentErrorPage--;
        displayErrorPage();
      }
    }

    // Îã§Ïùå ÌéòÏù¥ÏßÄ
    function nextErrorPage() {
      const totalPages = Math.ceil(logAnalysisData.errors.length / ERRORS_PER_PAGE);
      if (currentErrorPage < totalPages) {
        currentErrorPage++;
        displayErrorPage();
      }
    }

    // Î°úÍ∑∏ Î∂ÑÏÑù ÏôÑÎ£å Ïãú Ï¢ÖÌï©Î∂ÑÏÑù Î≤ÑÌäº ÌëúÏãú
    window.addEventListener('message', function(e) {
      if (e.data && e.data.cmd === 'complete') {
        const detailBtn = document.getElementById('btnDetail');
        if (detailBtn) {
          detailBtn.style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>
